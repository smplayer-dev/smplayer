name: Build Windows Packages with Qt 6.8

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Which package to build'
        required: true
        default: 'installer'
        type: choice
        options:
          - installer
  release:
    types: [published]

jobs:
  build:
    runs-on: windows-2022
    steps:
      - name: Checkout main repo
        run: git clone https://github.com/smplayer-dev/smplayer-build.git .

      - name: Install sources
        uses: actions/checkout@v4
        with:
          path: packages/smplayer
          ref: qt6
          fetch-depth: 0

      - name: Install themes
        run: |
          git clone --depth 1 https://github.com/smplayer-dev/smplayer-themes.git packages\smplayer-themes
          git clone --depth 1 https://github.com/smplayer-dev/smplayer-skins.git packages\smplayer-skins

      - name: Install players
        run: .\uncompress_players.cmd

      - name: Install Qt (64 bit)
        uses: jurplel/install-qt-action@v3
        with:
          aqtversion: '==3.1.*'
          version: '6.8.3'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_mingw'
          modules: 'qt5compat'
          tools: 'tools_mingw1310'

      - name: Set mingw path
        run: echo "$env:IQTA_TOOLS\mingw1310_64\bin\" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Compile themes
        run: .\compile_themes.cmd

      - name: Compile SMPlayer
        run: .\compile_smplayer.cmd

      - name: Install build
        run: .\install.cmd

      - name: Create installer package
        run: .\nsis.cmd
          $fn = Get-Content packages\BUILD\installer_filename.txt -TotalCount 1
          echo "PACKAGEFILENAME=$fn" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Gather artifact
        shell: bash
        run: |
          mkdir -p "$GITHUB_WORKSPACE/dist"
          found=$(find "$GITHUB_WORKSPACE" -type f -name "$PACKAGEFILENAME" -print -quit)
          if [ -z "$found" ]; then
            echo "ERROR: $PACKAGEFILENAME not found"
            exit 1
          fi
          mv "$found" "$GITHUB_WORKSPACE/dist/"

      - name: Upload to release
        if: github.event_name == 'release'
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: dist/${{ env.PACKAGEFILENAME }}
          tag: ${{ github.ref }}
          overwrite: true
